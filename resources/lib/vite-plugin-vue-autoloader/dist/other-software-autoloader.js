import { normalizePath as i } from "vite";
import p from "node:fs";
import * as V from "node:path";
import l, { basename as O, parse as D, resolve as m } from "node:path";
function A(t, e = [".vue"], n = []) {
  return p.existsSync(t) && p.readdirSync(t).forEach((a) => {
    const r = l.join(t, a);
    p.statSync(r).isDirectory() ? n = A(r, e, n) : e.forEach((u) => {
      r.endsWith(u) && n.push(r);
    });
  }), n;
}
function c(t) {
  return t.charAt(0).toUpperCase() + t.slice(1);
}
function I(t, e, n = void 0) {
  e = i(e), t = i(t);
  let o = e.replace(t, "").replace(/^\//, "").replace(".vue", "").split("/").join(".");
  return n ? n + "::" + o : o;
}
function M(t, e, n = void 0) {
  e = i(e), t = i(t);
  let o = e.replace(t, "").replace(/^\//, "").replace(".vue", "").split("/");
  return n && o.unshift(n), o.map(c).join("");
}
function j(t, e = void 0) {
  t = i(t);
  let n = O(t), o = D(n), a = c(o.name);
  return e ? c(e) + a : a;
}
function f(t, e, n = void 0) {
  const o = /* @__PURE__ */ new Map(), a = /* @__PURE__ */ new Map();
  return Array.isArray(e) && (e = Object.fromEntries(e.map((r) => [r, void 0]))), typeof e == "string" && (e = { [e]: void 0 }), Object.entries(e).forEach(([r, s]) => {
    s && d(m(t.root, s), a, o, n), d(m(t.root, r), a, void 0, n);
  }), { components: a, vendors: o };
}
function d(t, e, n = void 0, o = void 0) {
  A(t).forEach((a) => {
    let r = j(a, o), s = I(t, a, o), u = M(t, a, o);
    a = i(a), n && n.set(u, { global: r, name: u, laravel: s, path: a }), e.set(u, { global: r, name: u, laravel: s, path: a });
  });
}
function x(t) {
  let e = [];
  return t.forEach((n) => e.push(`import ${n.global} from '${n.path}';`)), e.push("export {"), t.forEach((n) => e.push(`  ${n.global},`)), e.push("};"), e.push(""), e.push("export function createOtherSoftwareAutoloader() {"), e.push("  return {"), e.push("    install(app) {"), t.forEach((n) => e.push(`      app.component('${n.global}', ${n.global});`)), e.push("    },"), e.push("  };"), e.push("};"), e.push(""), e.join(`
`);
}
function w(t, e, n, o) {
  let a = l.resolve(t.root, n), r = l.resolve(a, "components.d.ts"), s = [];
  s.push("// THIS FILE IS AUTOGENERATED!"), s.push("// DO NOT EDIT!"), s.push(""), s.push(`declare module '@${e.namespace}/components' {`), s.push("  import { Plugin } from 'vue';"), s.push("  export function createOtherSoftwareAutoloader(): Plugin;"), s.push(""), o.forEach((u) => s.push(`  export { default as ${u.global} } from '${i(l.relative(a, u.path))}';`)), s.push("}"), s.push(""), p.writeFileSync(r, s.join(`
`));
}
function v(t, e, n) {
  let o = l.resolve(t.root, e), a = l.resolve(o, "vue.d.ts"), r = [];
  r.push("// THIS FILE IS AUTOGENERATED!"), r.push("// DO NOT EDIT!"), r.push(""), r.push("declare module '@vue/runtime-core' {"), r.push("  export interface GlobalComponents {"), n.forEach((s) => r.push(`    ${s.global}: typeof import('${i(l.relative(o, s.path))}')['default'],`)), r.push("  }"), r.push("}"), r.push(""), r.push("export {}"), r.push(""), p.writeFileSync(a, r.join(`
`));
}
function T(t) {
  return Array.isArray(t) ? [t.at(0), void 0] : typeof t == "string" ? [t, void 0] : Object.entries(t).at(0);
}
function E(t, e, n = !0) {
  const o = T(e.target);
  if (!o)
    throw new Error("Unknown target for output files!");
  let [a, r] = o, s = f(t, e.components);
  return r && (w(t, e, r, s.vendors), v(t, r, s.vendors)), w(t, e, a, s.components), v(t, a, s.components), n ? x(s.components) : null;
}
function R(t) {
  let e = [];
  return t.forEach((n) => e.push(`import ${n.name} from '${n.path}';`)), e.push(""), e.push("const ViewsRepository = {"), t.forEach((n) => e.push(`  '${n.laravel}': ${n.name},`)), e.push("};"), e.push(""), e.push("export function createViewResolver(name) {"), e.push("  const view = ViewsRepository[name];"), e.push(""), e.push("  if (!view) {"), e.push(`    throw new Error('View "' + name + '" not found!');`), e.push("  }"), e.push(""), e.push("  return view;"), e.push("}"), e.push(""), e.join(`
`);
}
function y(t, e, n) {
  let o = l.resolve(t.root, n), a = l.resolve(o, "views.d.ts"), r = [];
  r.push("// THIS FILE IS AUTOGENERATED!"), r.push("// DO NOT EDIT!"), r.push(""), r.push(`declare module '@${e.namespace}/views' {`), r.push("  export function createViewResolver(name: string): any;"), r.push("}"), r.push(""), p.writeFileSync(a, r.join(`
`));
}
function S(t, e, n) {
  let o = l.resolve(t.root, e), a = l.resolve(o, ".phpstorm.meta.php"), r = [], s = [];
  n.forEach((u) => s.push(`'${u.laravel}'`)), r.push("<?php"), r.push(""), r.push("namespace PHPSTORM_META {"), r.push(`  registerArgumentsSet('vueApplicationViews', ${s.join(", ")});`), r.push(""), r.push("  expectedArguments(\\OtherSoftware\\Bridge\\ResponseFactory::view(), 0, argumentsSet('vueApplicationViews'));"), r.push("  expectedArguments(\\OtherSoftware\\Support\\Facades\\Vue::view(), 0, argumentsSet('vueApplicationViews'));"), r.push("}"), r.push(""), p.writeFileSync(a, r.join(`
`));
}
function g(t, e, n = !0) {
  const o = T(e.target);
  if (!o)
    throw new Error("Unknown target for output files!");
  let [a, r] = o;
  const s = f(t, e.views, e.namespace);
  return r && (y(t, e, r), S(t, r, s.vendors)), y(t, e, a), S(t, a, s.components), n ? R(s.components) : null;
}
let h = /* @__PURE__ */ new Map();
function $(t, e) {
  let n = f(t, e.views, e.namespace), o = e.namespace || "default", a = /* @__PURE__ */ new Set();
  h.set(o, a), n.components.forEach((r) => {
    a.add(r.path);
  }), n.vendors.forEach((r) => {
    a.add(r.path);
  });
}
function C(t, e) {
  $(t, e);
}
function b(t, e, n, o) {
  h.has(e.namespace || "default") || $(t, e);
  const a = V.normalize(o);
  if (!o.endsWith(".vue") || !h.get(e.namespace || "default").has(a))
    return { code: n, map: null };
  if (n.includes("<template>") && !n.includes("<RouterView") && !n.includes("<router-view")) {
    const r = n.lastIndexOf("</template>"), s = n.slice(0, r), u = n.slice(r);
    return { code: `${s}
  <RouterView />
${u}`, map: null };
  }
  return { code: n, map: null };
}
function N(t) {
  let e;
  function n(o) {
    E(e, t, !1), g(e, t, !1), C(e, t);
    const a = o.moduleGraph.getModuleById("\0@" + t.namespace + "/components"), r = o.moduleGraph.getModuleById("\0@" + t.namespace + "/views");
    a && o.reloadModule(a), r && o.reloadModule(r);
  }
  return {
    name: "vue-autoloader",
    enforce: "pre",
    configResolved(o) {
      e = o;
    },
    resolveId(o) {
      if (o === "@" + t.namespace + "/components") return "\0@" + t.namespace + "/components";
      if (o === "@" + t.namespace + "/views") return "\0@" + t.namespace + "/views";
    },
    load(o) {
      if (o === "\0@" + t.namespace + "/components") return E(e, t);
      if (o === "\0@" + t.namespace + "/views") return g(e, t);
    },
    async transform(o, a) {
      return b(e, t, o, a);
    },
    configureServer(o) {
      const a = (r) => {
        r.endsWith(".vue") && n(o);
      };
      o.watcher.on("add", a), o.watcher.on("unlink", a), o.watcher.on("addDir", a), o.watcher.on("unlinkDir", a);
    }
  };
}
export {
  N as default
};
