{"version":3,"file":"other-software-server.js","sources":["../src/main.ts"],"sourcesContent":["import * as process from 'node:process';\nimport { createServer, type IncomingMessage } from 'node:http';\nimport type { InitialState } from '@othersoftware/foundation';\n\ntype AppCallback = (state: InitialState) => Promise<string>\ntype RouteHandler = (request: IncomingMessage) => Promise<any>\n\nconst readableToString: (readable: IncomingMessage) => Promise<string> = (readable) => new Promise((resolve, reject) => {\n  let data = '';\n  readable.on('data', (chunk) => (data += chunk));\n  readable.on('end', () => resolve(data));\n  readable.on('error', (err) => reject(err));\n});\n\nexport function startRenderingService(render: AppCallback, port: number = 2137): void {\n  const routes: Record<string, RouteHandler> = {\n    '/health': async () => ({ status: 'OK', timestamp: Date.now() }),\n    '/shutdown': () => process.exit(),\n    '/render': async (request) => render(JSON.parse(await readableToString(request))),\n    '/404': async () => ({ status: 'NOT_FOUND', timestamp: Date.now() }),\n  };\n\n  createServer(async (request, response) => {\n    const dispatchRoute = routes[request.url as string] || routes['/404'];\n\n    try {\n      response.writeHead(200, { 'Content-Type': 'text/html', Server: 'OtherCommerce Visitor SSR' });\n      response.write(await dispatchRoute(request));\n    } catch (e) {\n      console.error(e);\n    }\n\n    response.end();\n  }).listen(port, () => {\n    console.log('Rendering service started started.');\n  });\n\n  console.log(`Starting rendering service on port ${port}...`);\n}\n"],"names":[],"mappings":";;AAOA,MAAM,mBAAmE,CAAC,aAAa,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtH,MAAI,OAAO;AACX,WAAS,GAAG,QAAQ,CAAC,UAAW,QAAQ,KAAM;AAC9C,WAAS,GAAG,OAAO,MAAM,QAAQ,IAAI,CAAC;AACtC,WAAS,GAAG,SAAS,CAAC,QAAQ,OAAO,GAAG,CAAC;AAC3C,CAAC;AAEM,SAAS,sBAAsB,QAAqB,OAAe,MAAY;AACpF,QAAM,SAAuC;AAAA,IAC3C,WAAW,aAAa,EAAE,QAAQ,MAAM,WAAW,KAAK;IACxD,aAAa,MAAM,QAAQ,KAAA;AAAA,IAC3B,WAAW,OAAO,YAAY,OAAO,KAAK,MAAM,MAAM,iBAAiB,OAAO,CAAC,CAAC;AAAA,IAChF,QAAQ,aAAa,EAAE,QAAQ,aAAa,WAAW,KAAK,MAAI;AAAA,EAAE;AAGpE,eAAa,OAAO,SAAS,aAAa;AACxC,UAAM,gBAAgB,OAAO,QAAQ,GAAa,KAAK,OAAO,MAAM;AAEpE,QAAI;AACF,eAAS,UAAU,KAAK,EAAE,gBAAgB,aAAa,QAAQ,6BAA6B;AAC5F,eAAS,MAAM,MAAM,cAAc,OAAO,CAAC;AAAA,IAAA,SACpC,GAAG;AACV,cAAQ,MAAM,CAAC;AAAA,IAAA;AAGjB,aAAS,IAAA;AAAA,EAAI,CACd,EAAE,OAAO,MAAM,MAAM;AACpB,YAAQ,IAAI,oCAAoC;AAAA,EAAA,CACjD;AAED,UAAQ,IAAI,sCAAsC,IAAI,KAAK;AAC7D;"}